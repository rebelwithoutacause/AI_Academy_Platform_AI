name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  quick-validation:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate project structure
      run: |
        echo "ðŸ” Validating project structure..."

        # Check if main directories exist
        [ -d "frontend/nextjs" ] && echo "âœ… Frontend directory exists" || { echo "âŒ Frontend directory missing"; exit 1; }
        [ -d "backend/laravel" ] && echo "âœ… Backend directory exists" || { echo "âŒ Backend directory missing"; exit 1; }

        # Check if key files exist
        [ -f "frontend/nextjs/package.json" ] && echo "âœ… Frontend package.json exists" || { echo "âŒ Frontend package.json missing"; exit 1; }
        [ -f "backend/laravel/composer.json" ] && echo "âœ… Backend composer.json exists" || { echo "âŒ Backend composer.json missing"; exit 1; }
        [ -f "docker-compose.yml" ] && echo "âœ… Docker compose file exists" || { echo "âŒ Docker compose file missing"; exit 1; }

        echo "âœ… Project structure validation passed"

    - name: Validate Docker configuration
      run: |
        echo "ðŸ³ Validating Docker configuration..."

        # Check if Dockerfiles exist
        [ -f "frontend/nextjs/Dockerfile" ] && echo "âœ… Frontend Dockerfile exists" || echo "âš ï¸ Frontend Dockerfile missing"
        [ -f "backend/laravel/Dockerfile" ] && echo "âœ… Backend Dockerfile exists" || echo "âš ï¸ Backend Dockerfile missing"

        # Validate docker-compose syntax
        docker compose config > /dev/null && echo "âœ… Docker Compose syntax valid" || { echo "âŒ Docker Compose syntax invalid"; exit 1; }

    - name: Validate package.json and composer.json
      run: |
        echo "ðŸ“¦ Validating package configurations..."

        # Validate frontend package.json
        cd frontend/nextjs
        node -e "JSON.parse(require('fs').readFileSync('package.json', 'utf8'))" && echo "âœ… Frontend package.json valid" || { echo "âŒ Frontend package.json invalid"; exit 1; }

        # Validate backend composer.json
        cd ../../backend/laravel
        php -r "json_decode(file_get_contents('composer.json'), true);" && echo "âœ… Backend composer.json valid" || { echo "âŒ Backend composer.json invalid"; exit 1; }

    - name: Generate CI Status Report
      run: |
        echo "## ðŸš€ CI Validation Results" > ci-report.md
        echo "" >> ci-report.md
        echo "| Component | Status |" >> ci-report.md
        echo "|-----------|--------|" >> ci-report.md
        echo "| Project Structure | âœ… Valid |" >> ci-report.md
        echo "| Docker Configuration | âœ… Valid |" >> ci-report.md
        echo "| Package Configurations | âœ… Valid |" >> ci-report.md
        echo "" >> ci-report.md
        echo "**All basic validations passed!** ðŸŽ‰" >> ci-report.md

        cat ci-report.md

  call-tests:
    needs: quick-validation
    strategy:
      matrix:
        test-type: [frontend, backend, docker]

    runs-on: ubuntu-latest

    steps:
    - name: Trigger specific test workflow
      run: |
        echo "âœ… Quick validation passed - ${{ matrix.test-type }} tests would be triggered"
        echo "This job represents the successful completion of basic validation"
        echo "Individual test workflows (frontend-tests.yml, backend-tests.yml, docker-build.yml) will run in parallel"